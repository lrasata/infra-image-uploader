import boto3
import os

s3 = boto3.client('s3')
QUARANTINE_BUCKET = os.environ['QUARANTINE_BUCKET']

def handler(event, context):
    detail = event['detail']
    
    # Only process malware findings
    if detail['type'] != "Recon:EC2/Malware":
        return

    # Extract file and bucket info from GuardDuty finding
    # (depends on how EC2 reports; you may tag files or store key in SSM)
    infected_file_key = detail['resource']['s3Object']['key']
    source_bucket = detail['resource']['s3Object']['bucketName']

    # Move infected file to quarantine and delete from source bucket
    s3.copy_object(
        Bucket=QUARANTINE_BUCKET,
        CopySource={'Bucket': source_bucket, 'Key': infected_file_key},
        Key=infected_file_key
    )
    s3.delete_object(Bucket=source_bucket, Key=infected_file_key)
    print(f"File {infected_file_key} moved to quarantine bucket.")
